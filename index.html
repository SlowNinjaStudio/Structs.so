<!doctype html>
<html class="no-js" lang="">

<head>
  <meta charset="utf-8">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="">
  <meta property="og:type" content="">
  <meta property="og:url" content="">
  <meta property="og:image" content="">

  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="icon.png">
  <!-- Place favicon.ico in the root directory -->

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/main.css">

  <meta name="theme-color" content="#fafafa">
</head>

<body>

<div class="game-asset-wrapper">
  <!-- Add your site or application content here -->
  <canvas id="gameAsset" class="pixel-art-viewer" width="64" height="64" style="border:1px solid #000000;">
    Your browser does not support the canvas element.
  </canvas>
</div>
  <script>
    class ColorRGB {
      constructor(r, g, b) {
        this.r = r;
        this.g = g;
        this.b = b;
      }
    }

    class PixelArtViewer {

      /**
       * @param {HTMLCanvasElement} canvas the target canvas that will become the viewer
       * @param {Array.<string>} imageLayerPaths the paths to the images to render. Image layers are rendered in order.
       */
      constructor(canvas, imageLayerPaths) {
        this.canvas = canvas;
        this.aspectRatio = canvas.height / canvas.width;
        this.context = canvas.getContext("2d");
        this.imageLayerPaths = imageLayerPaths;
        this.numImagesLoaded = 0;
        this.layers = [];

        this.lockAspectRatio();
        this.loadAndRenderImageLayers();
      }

      /**
       * Locks the aspect ratio so that the aspect ratio is maintained even if the image is responsively resized.
       */
      lockAspectRatio() {
        this.canvas.height = this.canvas.width * this.aspectRatio;
      }

      /**
       * Check that all images have been loaded. Used before rendering to reduce re-renders.
       * @returns {boolean}
       */
      areAllImagesLoaded() {
        return this.numImagesLoaded === this.imageLayerPaths.length;
      }

      /**
       * Loads and renders the image layers in the order defined by the image paths.
       */
      loadAndRenderImageLayers() {
        for(let i = 0; i < this.imageLayerPaths.length; i++) {
          const img = new Image();
          const viewer = this;
          img.onload = () => {
            viewer.numImagesLoaded++;
            if (viewer.areAllImagesLoaded) {
              viewer.render();
            }
          }
          img.src = this.imageLayerPaths[i];
          this.layers[i] = img;
        }
      }

      /**
       * Draw all image layers to the canvas in order.
       */
      render() {
        this.clearCanvas();
        for(let i = 0; i < this.layers.length; i++) {
          this.context.drawImage(this.layers[i], 0, 0);
        }
      }

      /**
       * Swap colors in the canvas.
       * @param {ColorRGB} targetColor
       * @param {ColorRGB} newColor
       */
      swapColor(targetColor, newColor) {
        const imageData = this.context.getImageData(0, 0, this.canvas.width, this.canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const red = data[i];
          const green = data[i + 1];
          const blue = data[i + 2];
          if (red === targetColor.r && green === targetColor.g && blue === targetColor.b) {
            data[i]     = newColor.r; // red
            data[i + 1] = newColor.g; // green
            data[i + 2] = newColor.b; // blue
          }
        }
        this.context.putImageData(imageData, 0, 0);
      }

      /**
       * Given an array of color pairs, swap the first color with the second color in the canvas.
       * @param {Array.<Array>} colorSwapList
       */
      swapColors(colorSwapList) {
        for (let i = 0; i < colorSwapList.length; i++) {
          this.swapColor(colorSwapList[i][0], colorSwapList[i][1]);
        }
      }

      clearCanvas() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
      }
    }

    /** @type {HTMLCanvasElement} */
    const canvas = document.getElementById("gameAsset");

    const imageLayerPaths = [
      'img/structure-bg-default.png',
      'img/structure-bg-space.png',
      'img/structure-bg-water.png',
      'img/structure-bg-lighten-15.png',
      'img/structure-static-buildings.png',
      'img/structure-static-water.png',
      'img/structure-static-space.png'
    ];

    const pixelArtViewer = new PixelArtViewer(canvas, imageLayerPaths);

    document.addEventListener('click', () => {
      pixelArtViewer.swapColors([
        [new ColorRGB(0, 0, 0), new ColorRGB(255, 255, 255)],
        [new ColorRGB(238, 238, 238), new ColorRGB(255, 100, 100)]
      ]);
    });
  </script>

  <script src="js/vendor/modernizr-3.11.2.min.js"></script>
  <script src="js/plugins.js"></script>
  <script src="js/main.js"></script>

  <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
<!--  <script>-->
<!--    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;-->
<!--    ga('create', 'UA-XXXXX-Y', 'auto'); ga('set', 'anonymizeIp', true); ga('set', 'transport', 'beacon'); ga('send', 'pageview')-->
<!--  </script>-->
<!--  <script src="https://www.google-analytics.com/analytics.js" async></script>-->
</body>

</html>
