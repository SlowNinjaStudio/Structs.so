<!doctype html>
<html lang="en-us">
	<head>
    <title>Drag and Drop</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html {
        background-image: url("im/dot-grid.png");
        background-repeat: repeat;
        font-family:  sans-serif;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-edges;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        text-align: center;
      }
      h1 {
        display: inline-block;
        font-size:  24px;
        margin-top:  40px;
        margin-bottom: 30px;
      }
      #testLogo {
        margin-right:  10px;
        vertical-align: text-bottom;
        width: 32px;
      }
      #display {
        margin: 20px 0;
      }
      .draggableBox {
        border: 1px solid black;
        display: inline-block;
        height: 64px;
        width: 64px;
      }
      .droppableContainer {
        border: 1px solid black;
        margin: 20px;
        min-height: 200px;
        padding: 20px;
      }
      .snapTarget {
        display: inline-block;
        position: relative;
        height: 65px;
        width: 65px;
        padding: 4px;
        border: 4px solid #222222;
        background: #444444;
      }
      .bg-green {
        background: mediumseagreen;
      }
      .bg-blue {
        background: dodgerblue;
      }
      .bg-yellow {
        background: goldenrod;
      }
    </style>
	</head>
	<body id="body">

		<div>
			<h1><img id="testLogo" src="im/test_logo.png" alt="Test Logo">Drag & Drop</h1>
		</div>
    <div id="display"></div>
    <div class="droppableContainer bg-blue">
      <div id="box1" class="draggableItem draggableBox bg-yellow"></div>
    </div>
    <div id='container2' class="droppableContainer bg-green">
      <div id='snapTarget2' class="snapTarget"></div>
    </div>
    <div id="dragNDropEventBus"></div>
    <script>
      let isDragging = false;

      class CoordinateError extends Error {

        /**
         * @param {string} message
         */
        constructor(message) {
          super(message);
          this.name = "CoordinateError";
        }

      }

      class Coordinate {

        /**
         * @param {number} x
         * @param {number} y
         */
        constructor(x, y) {
          this.x = x;
          this.y = y;
        }

        /**
         * @param {Event} event
         * @return {Coordinate}
         */
        static makeFromEvent(event) {
          if (event instanceof TouchEvent && event.changedTouches.length > 0) {
            return new Coordinate(event.changedTouches[0].pageX, event.changedTouches[0].pageY);
          } else if (event instanceof MouseEvent) {
            return new Coordinate(event.pageX, event.pageY);
          } else {
            throw new CoordinateError('Unknown event type');
          }
        }

      }

      class ElementInfo {

        /**
         * @param {HTMLElement} element
         */
        static getElementCenter(element) {
          return new Coordinate(
            Math.floor(element.offsetWidth / 2),
            Math.floor(element.offsetHeight / 2),
          );
        }

        /**
         * @param {HTMLElement} element
         * @return {Coordinate}
         */
        static getPosition(element) {
          const rect = element.getBoundingClientRect();
          const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          return new Coordinate(rect.left + scrollLeft, rect.top + scrollTop);
        }

      }

      class Rectangle {

        /**
         * @param {Number} width
         * @param {Number} height
         * @param {Number} x
         * @param {Number} y
         */
        constructor(width, height, x = 0, y = 0) {
          this.width = width;
          this.height = height;
          this.x = x;
          this.y = y;
        }

        /**
         * @param {Coordinate} point
         * @return {boolean}
         */
        isPointInside(point) {
          return this.x <= point.x && point.x <= this.x + this.width
            && this.y <= point.y && point.y <= this.y + this.height;
        }

      }

      class DraggableItem {

        /**
         * @param {string} draggableItemId
         * @param {string} dragType COPY|MOVE
         */
        constructor(draggableItemId, dragType = 'MOVE') {
          this.draggableItemId = draggableItemId;
          this.draggableItem = null;
          this.dragType = dragType;
          this.initalZIndex = 0;
        }

        init() {
          this.draggableItem = document.getElementById(this.draggableItemId);

          // Back up the initial z-index, so it can be restored when the item is dropped in the right location
          this.initalZIndex =  this.draggableItem.style.zIndex;

          const initialZIndex = this.initalZIndex;

          const itemCenter = ElementInfo.getElementCenter(this.draggableItem);

          const onDrag = draggableItem => (e) => {
            const coordinate = Coordinate.makeFromEvent(e);
            draggableItem.style.left = coordinate.x - itemCenter.x + 'px';
            draggableItem.style.top = coordinate.y - itemCenter.y + 'px';
          }

          const itemDragHandler = onDrag(this.draggableItem);

          const onDragStart = function (eventName) {
            return function (e) {
              e.preventDefault();
              isDragging = true;

              const coordinate = Coordinate.makeFromEvent(e);
              this.draggableItem.style.position = 'absolute';
              this.draggableItem.style.zIndex = '999';
              this.draggableItem.style.left = coordinate.x - itemCenter.x + 'px';
              this.draggableItem.style.top = coordinate.y - itemCenter.y + 'px';

              document.body.appendChild(this.draggableItem);
              document.addEventListener(eventName, itemDragHandler);
            }
          }

          const onDrop = function (eventName) {
            return function (e) {
              e.preventDefault();
              isDragging = false;
              document.removeEventListener(eventName, itemDragHandler);
              this.draggableItem.style.zIndex = initialZIndex;

              const mousePosition = Coordinate.makeFromEvent(e);
              const draggableItem = this.draggableItem;
              const dropEvent = new CustomEvent('DRAG_N_DROP_DROP', {
                detail: {
                  x: mousePosition.x,
                  y: mousePosition.y,
                  draggableItem
                }
              });

              const eventBus = document.getElementById('dragNDropEventBus');
              eventBus.dispatchEvent(dropEvent);
            }
          }

          const touchStartHandler = onDragStart('touchmove');
          const mouseDownHandler = onDragStart('mousemove');

          const touchEndHandler = onDrop('touchend');
          const mouseUpHandler = onDrop('mouseup');

          this.draggableItem.addEventListener('touchstart', touchStartHandler.bind(this));
          this.draggableItem.addEventListener('mousedown', mouseDownHandler.bind(this));

          this.draggableItem.addEventListener('touchend', touchEndHandler.bind(this));
          this.draggableItem.addEventListener('mouseup', mouseUpHandler.bind(this));
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const draggableBox = new DraggableItem('box1');
        draggableBox.init();

        const eventBus = document.getElementById('dragNDropEventBus');
        eventBus.addEventListener('DRAG_N_DROP_DROP', function(e) {
          const droppableContainer = document.getElementById('container2');
          const position = ElementInfo.getPosition(droppableContainer);
          const droppableArea = new Rectangle(
            droppableContainer.offsetWidth,
            droppableContainer.offsetHeight,
            position.x,
            position.y
          );
          if (droppableArea.isPointInside(new Coordinate(e.detail.x, e.detail.y))) {
            console.log('dropped inside', e);
            document.getElementById('snapTarget2').appendChild(e.detail.draggableItem);
            e.detail.draggableItem.style.position = 'relative';
            e.detail.draggableItem.style.left = 'auto';
            e.detail.draggableItem.style.top = 'auto';
            e.detail.draggableItem.style.zIndex = '0';
          }
        });

        window.addEventListener('mousemove', (e) => {
          const droppableContainer = document.getElementById('container2');
          const position = ElementInfo.getPosition(droppableContainer);
          const droppableArea = new Rectangle(
            droppableContainer.offsetWidth,
            droppableContainer.offsetHeight,
            position.x,
            position.y
          );
          if (isDragging) {
            const mousePosition = Coordinate.makeFromEvent(e);
            if (droppableArea.isPointInside(mousePosition)) {
              console.log('over container', mousePosition);
            }
          }
        });
        window.addEventListener('touchmove', (e) => {
          const droppableContainer = document.getElementById('container2');
          const position = ElementInfo.getPosition(droppableContainer);
          const droppableArea = new Rectangle(
            droppableContainer.offsetWidth,
            droppableContainer.offsetHeight,
            position.x,
            position.y
          );
          if (isDragging) {
            const mousePosition = Coordinate.makeFromEvent(e);
            if (droppableArea.isPointInside(mousePosition)) {
              console.log('over container', mousePosition);
            }
          }
        });
      });
    </script>
	</body>
</html>
