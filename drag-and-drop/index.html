<!doctype html>
<html lang="en-us">
	<head>
    <title>Drag and Drop</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      html {
        background-image: url("im/dot-grid.png");
        background-repeat: repeat;
        font-family:  sans-serif;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-crisp-edges;
        image-rendering: pixelated;
        image-rendering: crisp-edges;
        text-align: center;
      }
      h1 {
        display: inline-block;
        font-size:  24px;
        margin-top:  40px;
        margin-bottom: 10px;
      }
      #testLogo {
        margin-right:  10px;
        vertical-align: text-bottom;
        width: 32px;
      }
      .displayContainer {
        border: 4px solid black;
        display: inline-block;
        font-size: 0;
        height: 256px;
        margin: 20px;
        position: relative;
        width: 256px;
      }
      #detailedItemView {
        height: 256px;
        width: 256px;

        border: 0;
        margin: 0;
        padding: 0;

        position: absolute;
        top: 0;
        left: 0;
        z-index: 0;
      }
      #detailedItemViewDroppableArea {
        height: 256px;
        width: 256px;

        border: 0;
        margin: 0;
        padding: 0;

        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;

        background: rgba(255, 255, 255, 0.75);
      }
      #snapTargetBarrel {
        height: 12px;
        width: 156px;

        border: 1px dotted black;
        margin: 0;
        padding: 0;

        position: absolute;
        top: 115px;
        left: 27px;
      }
      #snapTargetRecoil {
        height: 20px;
        width: 136px;

        border: 1px dotted black;
        margin: 0;
        padding: 0;

        position: absolute;
        top: 127px;
        left: 47px;
      }
      #snapTargetReceiver {
        height: 32px;
        width: 32px;

        border: 1px dotted black;
        margin: 0;
        padding: 0;

        position: absolute;
        top: 111px;
        left: 183px;
      }
      .partsContainer {
        background: rgba(255, 255, 255, 0.5);
        border: 4px solid black;
        margin: 8px;
        padding: 8px;
      }
      .partContainer {
        display: inline-block;
        border: 1px dashed black;
        margin: 5px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.5);
      }
    </style>
	</head>
	<body id="body">

		<div>
			<h1><img id="testLogo" src="im/test_logo.png" alt="Test Logo">Drag & Drop</h1>
		</div>
    <div class="displayContainer">
      <img id="detailedItemView" src="im/car-attack-detailed.png" alt="Detailed Item View">
      <div id="detailedItemViewDroppableArea">
        <div id="snapTargetBarrel"></div>
        <div id="snapTargetRecoil"></div>
        <div id="snapTargetReceiver"></div>
      </div>
    </div>
    <div class="partsContainer">
      <div>
        <div class="partContainer">
          <img id="barrelStandard" src="im/car-attack-barrel-standard.png" alt="Standard Barrel">
        </div>
        <div class="partContainer">
          <img id="barrelMuzzleBreak" src="im/car-attack-barrel-muzzle-break.png" alt="Barrel with Muzzle Break">
        </div>
      </div>
      <div>
        <div class="partContainer">
          <img id="recoilSpring" src="im/car-attack-recoil-spring.png" alt="Spring Recoil Compensator">
        </div>
        <div class="partContainer">
          <img id="recoilHydraulic" src="im/car-attack-recoil-hydraulic.png" alt="Hydraulic Recoil Compensator">
        </div>
      </div>
      <div>
        <div class="partContainer">
          <img id="receiverMechanical" src="im/car-attack-receiver-mechanical.png" alt="Mechanical Receiver">
        </div>
        <div class="partContainer">
          <img id="receiverElectronic" src="im/car-attack-receiver-electronic.png" alt="Electronic Receiver">
        </div>
      </div>
    </div>
    <script>
      class CoordinateError extends Error {

        /**
         * @param {string} message
         */
        constructor(message) {
          super(message);
          this.name = "CoordinateError";
        }

      }

      class Coordinate {

        /**
         * @param {number} x
         * @param {number} y
         */
        constructor(x, y) {
          this.x = x;
          this.y = y;
        }

        /**
         * @param {Event} event
         * @return {Coordinate}
         * @throws {CoordinateError}
         */
        static makeFromEvent(event) {
          if (event instanceof TouchEvent && event.changedTouches.length > 0) {
            return new Coordinate(event.changedTouches[0].pageX, event.changedTouches[0].pageY);
          } else if (event instanceof MouseEvent) {
            return new Coordinate(event.pageX, event.pageY);
          } else {
            throw new CoordinateError('Unknown event type');
          }
        }

      }

      class ElementInfo {

        /**
         * @param {HTMLElement} element
         */
        static getElementCenter(element) {
          return new Coordinate(
            Math.floor(element.offsetWidth / 2),
            Math.floor(element.offsetHeight / 2),
          );
        }

        /**
         * @param {HTMLElement} element
         * @return {Coordinate}
         */
        static getPosition(element) {
          const rect = element.getBoundingClientRect();
          const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
          const scrollTop = window.scrollY || document.documentElement.scrollTop;
          return new Coordinate(rect.left + scrollLeft, rect.top + scrollTop);
        }

      }

      class Rectangle {

        /**
         * @param {Number} width
         * @param {Number} height
         * @param {Number} x
         * @param {Number} y
         */
        constructor(width, height, x = 0, y = 0) {
          this.width = width;
          this.height = height;
          this.x = x;
          this.y = y;
        }

        /**
         * @param {Coordinate} point
         * @return {boolean}
         */
        isPointInside(point) {
          return this.x <= point.x && point.x <= this.x + this.width
            && this.y <= point.y && point.y <= this.y + this.height;
        }

      }

      class DragNDropEventDetail {

        /**
         * @param {string} draggableItemId
         * @param {HTMLElement} draggableElement
         * @param {number} x
         * @param {number} y
         */
        constructor(draggableItemId, draggableElement, x, y) {
          this.draggableItemId = draggableItemId;
          this.draggableElement = draggableElement;
          this.x = x;
          this.y = y;
        }

        /**
         * @param {CustomEvent} customEvent
         * @return {DragNDropEventDetail}
         */
        static makeFromCustomEvent(customEvent) {
          return new DragNDropEventDetail(
            customEvent.detail.draggableItemId,
            customEvent.detail.draggableElement,
            customEvent.detail.x,
            customEvent.detail.y
          );
        }

        /**
         * @return {Coordinate}
         */
        getPosition() {
          return new Coordinate(this.x, this.y);
        }

      }

      class DragNDropDraggableItem {

        /**
         * @param {string} draggableItemId
         */
        constructor(draggableItemId) {
          this.draggableItemId = draggableItemId;
          this.originalDraggableElement = document.getElementById(this.draggableItemId);
          this.draggableElement = this.originalDraggableElement;
          this.initialZIndex = this.draggableElement.style.zIndex;
          this.elementCenter = ElementInfo.getElementCenter(this.draggableElement);
          this.copyCount = 0;
        }

        /**
         * @return {function}
         */
        onDrag() {
          return function(event) {
            const mousePosition = Coordinate.makeFromEvent(event);
            const detail = new DragNDropEventDetail(
              this.draggableItemId,
              this.draggableElement,
              mousePosition.x,
              mousePosition.y
            );
            const dragEvent = new CustomEvent('DRAG_N_DROP_DRAG', { detail });

            this.draggableElement.style.left = mousePosition.x - this.elementCenter.x + 'px';
            this.draggableElement.style.top = mousePosition.y - this.elementCenter.y + 'px';
            document.dispatchEvent(dragEvent);
          }.bind(this);
        }

        /**
         * @param {string} eventName
         * @param {function} itemDragHandler
         * @param {string} dragType COPY|MOVE
         * @param {HTMLElement} selectedDraggableElement
         * @return {function}
         */
        onDragStart(eventName, itemDragHandler, dragType = 'COPY', selectedDraggableElement = null) {
          return function (event) {
            event.preventDefault();

            if (dragType === 'COPY') {
              this.copyCount++;
              this.draggableElement = this.originalDraggableElement.cloneNode(true);
              this.draggableElement.id = `${this.draggableElement.id}-copy-${this.copyCount}`;
            } else if (dragType === 'MOVE' && selectedDraggableElement !== null) {
              this.draggableElement = selectedDraggableElement;
            }
            document.body.appendChild(this.draggableElement);

            const eventEnd = (eventName === 'touchmove') ? 'touchend' : 'mouseup';
            const endHandler = this.onDrop(eventName, itemDragHandler);
            document.addEventListener(eventEnd, endHandler, { once: true });

            const mousePosition = Coordinate.makeFromEvent(event);
            this.draggableElement.style.position = 'absolute';
            this.draggableElement.style.zIndex = '999';
            this.draggableElement.style.left = mousePosition.x - this.elementCenter.x + 'px';
            this.draggableElement.style.top = mousePosition.y - this.elementCenter.y + 'px';

            document.addEventListener(eventName, itemDragHandler);
          }.bind(this);
        }

        /**
         * @param {string} eventName
         * @param {function} itemDragHandler
         * @return {function}
         */
        onDrop(eventName, itemDragHandler) {
          return function (event) {
            event.preventDefault();

            document.removeEventListener(eventName, itemDragHandler);

            const eventStart = (eventName === 'touchmove') ? 'touchstart' : 'mousedown';
            this.draggableElement.addEventListener(eventStart, this.onDragStart(
              eventName,
              itemDragHandler,
              'MOVE',
              this.draggableElement
            ));

            this.draggableElement.style.zIndex = this.initialZIndex;

            const mousePosition = Coordinate.makeFromEvent(event);
            const detail = new DragNDropEventDetail(
              this.draggableItemId,
              this.draggableElement,
              mousePosition.x,
              mousePosition.y
            );
            const dropEvent = new CustomEvent('DRAG_N_DROP_DROP', { detail });

            document.dispatchEvent(dropEvent);
          }.bind(this);
        }

        init() {
          const itemDragHandler = this.onDrag();

          const touchStartHandler = this.onDragStart('touchmove', itemDragHandler, 'COPY');
          const mouseDownHandler = this.onDragStart('mousemove', itemDragHandler, 'COPY');

          this.originalDraggableElement.addEventListener('touchstart', touchStartHandler);
          this.originalDraggableElement.addEventListener('mousedown', mouseDownHandler);
        }

      }

      class DragNDropDroppableArea {

        /**
         * @param {string} droppableAreaId
         */
        constructor(droppableAreaId) {
          this.droppableAreaId = droppableAreaId;
          this.onDropInside = () => {};
          this.onDropOutside = () => {};
          this.onDragOver = () => {};
        }

        init() {
          document.addEventListener('DRAG_N_DROP_DROP', function(customEvent) {
            const dropEventDetail = DragNDropEventDetail.makeFromCustomEvent(customEvent);
            const droppableAreaElement = document.getElementById(this.droppableAreaId);
            const droppableAreaPosition = ElementInfo.getPosition(droppableAreaElement);
            const droppableAreaShape = new Rectangle(
              droppableAreaElement.offsetWidth,
              droppableAreaElement.offsetHeight,
              droppableAreaPosition.x,
              droppableAreaPosition.y
            );

            if (droppableAreaShape.isPointInside(dropEventDetail.getPosition())) {
              this.onDropInside(customEvent);
            } else {
              this.onDropOutside(customEvent);
            }
          }.bind(this));

          document.addEventListener('DRAG_N_DROP_DRAG', function(customEvent) {
            const dropEventDetail = DragNDropEventDetail.makeFromCustomEvent(customEvent);
            const droppableAreaElement = document.getElementById(this.droppableAreaId);
            const droppableAreaPosition = ElementInfo.getPosition(droppableAreaElement);
            const droppableArea = new Rectangle(
              droppableAreaElement.offsetWidth,
              droppableAreaElement.offsetHeight,
              droppableAreaPosition.x,
              droppableAreaPosition.y
            );

            if (droppableArea.isPointInside(dropEventDetail.getPosition())) {
              this.onDragOver(customEvent);
            }
          }.bind(this));
        }

      }

      class DragNDropSnapContainer {

        /**
         * @param {string} snapContainerId
         * @param {string} draggableItemId
         */
        constructor(snapContainerId, draggableItemId) {
          this.snapContainerId = snapContainerId;
          this.draggableItemId = draggableItemId;
          this.containerElement = document.getElementById(this.snapContainerId);
        }

      }

      class DragNDropDroppableAreaAutoSnap extends DragNDropDroppableArea {

        /**
         * @param {string} droppableAreaId
         */
        constructor(droppableAreaId) {
          super(droppableAreaId);
          this.snapContainers = new Map();
          this.onDropInside = function(customEvent) {
            console.log('dropped inside', customEvent);

            const detail = DragNDropEventDetail.makeFromCustomEvent(customEvent);
            const snapContainer = this.getSnapContainer(detail.draggableItemId);
            if (snapContainer) {
              snapContainer.containerElement.replaceChildren(detail.draggableElement);
              detail.draggableElement.style.position = 'relative';
              detail.draggableElement.style.left = 'auto';
              detail.draggableElement.style.top = 'auto';
              detail.draggableElement.style.zIndex = '0';
            } else {
              detail.draggableElement.remove();
            }
          }.bind(this);
          this.onDropOutside = function(customEvent) {
            const detail = DragNDropEventDetail.makeFromCustomEvent(customEvent);
            detail.draggableElement.remove();
          };
        }

        /**
         * @param {DragNDropSnapContainer} snapContainer
         */
        addSnapContainer(snapContainer) {
          this.snapContainers.set(snapContainer.draggableItemId, snapContainer);
        }

        /**
         * @param draggableItemId
         * @return {DragNDropSnapContainer}
         */
        getSnapContainer(draggableItemId) {
          return this.snapContainers.get(draggableItemId);
        }

      }

      window.addEventListener('load', () => {
        const draggableItems = [
          new DragNDropDraggableItem('barrelStandard'),
          new DragNDropDraggableItem('barrelMuzzleBreak'),
          new DragNDropDraggableItem('recoilSpring'),
          new DragNDropDraggableItem('recoilHydraulic'),
          new DragNDropDraggableItem('receiverMechanical'),
          new DragNDropDraggableItem('receiverElectronic')
        ];

        for (let i = 0; i < draggableItems.length; i++) {
          draggableItems[i].init();
        }

        const snapContainers = [
          new DragNDropSnapContainer('snapTargetBarrel', 'barrelStandard'),
          new DragNDropSnapContainer('snapTargetBarrel', 'barrelMuzzleBreak'),
          new DragNDropSnapContainer('snapTargetRecoil', 'recoilSpring'),
          new DragNDropSnapContainer('snapTargetRecoil', 'recoilHydraulic'),
          new DragNDropSnapContainer('snapTargetReceiver', 'receiverMechanical'),
          new DragNDropSnapContainer('snapTargetReceiver', 'receiverElectronic'),
        ];

        const detailedItemViewDroppableArea = new DragNDropDroppableAreaAutoSnap('detailedItemViewDroppableArea');

        for (let i = 0; i < snapContainers.length; i++) {
          detailedItemViewDroppableArea.addSnapContainer(snapContainers[i]);
        }

        detailedItemViewDroppableArea.init();
      });
    </script>
	</body>
</html>
